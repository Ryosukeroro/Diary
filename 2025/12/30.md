# 今日やったこと
A立くん用ICP作成_document

昨日はヘッダー作ったから今日は.cppや！

```cpp
/**
* @file map_to_pointcloud.cpp
*/

#include <map_to_pointcloud/map_to_pointcloud.hpp>

MapToPointCloudData::MapToPointCloudData(ros::NodeHandle node)
{
    sensor_msgs::PointField field;
    std::string sub_topic_name;
    std::string pub_topic_name;
    ros::NodeHandle param_node("~");

    // パラメータ読み込み
    getParam(param_node, "map_topic_name", sub_topic_name, std::string("/map")); // 点群化する地図の取得トピック名
    getParam(param_node, "cloud_topic_name", pub_topic_name, sub_topic_name + std::string("_cloud"));
    getParam(param_node, "occupied_thresh", occupied_thresh_, 50.0); // 占有してると判断する確率のしきい値
    getParam(param_node, "global_frame", global_frame_, std::string("lidar")); // 変換後の点群データのフレーム名
    getParam(param_node, "sensor_height", sensor_height_, 0.35); // 点群センサーの擬似的な高さ
    getParam(param_node, "publish_times", publish_times_, 0); // 配信回数

    // サブスクライバ定義
    sub_map = node.subscribe(sub_topic_name, ROS_QUEUE_SIZE_1, &MapToPointCloudData::recvMapCB, this);

    // パブリッシャ定義
    pub_cloud = node.advertise<sensor_msgs::PointCloud2>(pub_topic_name.c_str(), 10, true);
    

}

MapToPointCloudData::~MapToPointCloudData()
{
    // 何もしない
}

void MapToPointCloudData::recvMapCB(const nav_msgs::OccupancyGridPtr msg)
{
    unsigned int map_size = msg->data.size(); // 地図のサイズ
    std::vector<int8_t> map_data = msg->data; // 地図データ
    map_cell_width_= msg->info.width;
    map_cell_height_ = msg->info.height;
    origin_x_ = msg->info.origin.position.x;
    origin_y_ = msg->info.origin.position.y;
    resolution_ = msg->info.resolution;

    std::vector<PointXYZ> cloud_data;
    cloud_data.reserve(map_size);

    // 地図データをクロールして閾値以上のセル座標を抜き出す
    for(unsigned int idx = 0; idx < map_size; ++idx)
    {
        // 閾値判定
        if( map_data[idx] == UNKNOWN_COST_GRIDMAP || // UNKNOWN = -1
            map_data[idx] == FREESPACE_COST_GRIDMAP || // FREESPACE = 0
            map_data[idx] < occupied_thresh_ ) // 閾値となる占有確率以下
        {
            continue;
        }

        unsigned int cell_x, cell_y; // 該当セルの座標値
        double x, y; // 原点からの距離

        indexToCells(idx, cell_x, cell_y); // セル座標を求める
        mapToWorld(cell_x, cell_y, x, y); // 地図座標系からワールド座標系に変換

        // データの格納
        cloud_data.emplace_back((float)x, (float)y, sensor_height_);
    }

    // 配信する点群データの作成
    sensor_msgs::PointCloud2 cloud_msg;
    cloud_msg.header = msg->header;
    cloud_msg.header.frame_id = global_frame_; // パラメータで設定したフレーム (例: "lidar")

    // 2. 「中身はx, y, z のfloatだよ」という説明書を作る
    sensor_msgs::PointField field_x, field_y, field_z;
    field_x.name = "x"; field_x.offset = 0; field_x.datatype = sensor_msgs::PointField::FLOAT32; field_x.count = 1;
    field_y.name = "y"; field_y.offset = 4; field_y.datatype = sensor_msgs::PointField::FLOAT32; field_y.count = 1;
    field_z.name = "z"; field_z.offset = 8; field_z.datatype = sensor_msgs::PointField::FLOAT32; field_z.count = 1;

    cloud_msg.fields.push_back(field_x);
    cloud_msg.fields.push_back(field_y);
    cloud_msg.fields.push_back(field_z);

    // 3. データサイズなどの設定
    int n_points = cloud_data.size();
    cloud_msg.height = 1;
    cloud_msg.width = n_points;
    cloud_msg.is_bigendian = false;
    cloud_msg.point_step = sizeof(PointXYZ); // 構造体のサイズ (12byte)
    cloud_msg.row_step = cloud_msg.point_step * n_points;
    cloud_msg.is_dense = true;

    // 4. データを流し込む (これが makeShared の代わりの作業!)
    cloud_msg.data.resize(n_points * sizeof(PointXYZ));

    if (n_points > 0) {
        // vectorの中身をそのままメッセージのdata領域にコピー
        memcpy(&cloud_msg.data[0], &cloud_data[0], cloud_msg.data.size());
    }

    // 5. 送信!
    pub_cloud.publish(cloud_msg);

#ifndef DEBUG
     ROS_INFO("!!!!!Pub PointCloud Data!!!!!");
#endif






}
```

俺の元のコードも修正するか

# 明日やること
銀行振り込み

修論_実験

A立くん用ICP作成_document

修論_参考文献

ESA更新残り10分

Toeic単語

Toeic単語

絵

運動

髭剃り

ポケモン

Toeic勉強_25分かけてやりや。

ピッチング

pitching

運動

パンツ洗濯

靴下洗濯

ひげそり

Toeic_Part5残り3分

引っ越し準備

パンツ洗濯

Toeic_Part2

靴下洗濯

Toeic_単語_前編

Toeic_Part2残り19分

ポケモン

being確認

運動

修論_手法_ICP

gmapping_実装

being

保田課題

ロボットのCAD

廊下作成

帰省準備

pitching

turtlebot_joy

運動

# 豊田自動織機入社準備
マイナンバー申請

# メモ
アスクルの箱買おう。まだ停止中...

ヘッドホン貯金6000円

香水欲しい...

角パイプはいらんかな...寄付で。

回路置き場もいらん。寄付で。

音読しようぜ！

ヘッドバンイヤホン

Toeic_勉強

錆取り剤

靴下洗濯

マウス貯金5000円

ほごめがね

エンドミル

スリットカラー

ズボン欲しい:https://shop.newbalance.jp/pd/AMP55254.html?dwvar_AMP55254_style=AMP55254BK

ズボン貯金:4000円

M3ボルト欲しいな...

1/9修論仮提出

運動用の服欲しいかも：https://shop.newbalance.jp/pd/MT41256.html?dwvar_MT41256_style=MT41256BK#dwvar_MT41256_style=MT41256BEA&pid=MT41256-BEA-JP&quantity=1

iPad貯金3000円

大谷翔平基板作り直し

肉:https://store.shopping.yahoo.co.jp/tea-agent-japan/774.html?nodeeplink=0

Harris検出

https://gearup.la/products/the-heart-of-a-lion-global-shipping-la-baseball-collection?pr_prod_strat=e5_desc&pr_rec_id=a4aad5ef6&pr_rec_pid=9114375848188&pr_ref_pid=9113699713276&pr_seq=uniform

yolo画像

being確認

ボールペン使うときは一行書いて乾かしましょう。

TEST-001貯金 4000円

ホテル予約
# よくなかったこと・不安なこと
Toeicあかんかった...点数下がった悔しい。3月とか卒業前にリベンジや

料理のレパートリー欲しいかも:https://www.tsukijiichiba.com/user/product/22950?option=27035

思ったより加工に時間かかった。45分くらい。ドリル貫通0.2mmくらい。

銀行口座の資料をよく読むべきだった。確認も含めて

G-mappingに負けた...どうしよ

ズボンほつれ

論文出さないと留年？

めっちゃ雨に濡れた...もう傘必須か？学校に置き傘買うのもあり


# よかったこと・嬉しかったこと
リスニングの点数は前回より上がってる。これは良いことだ！

Toeic_Part5デビュー！

もう、ゼミなし！ミーティング行きましょう！
